
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Techniques to profile and optimise python code &#8212; Computational Physics U24568</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Acknowledgements" href="acknowledgements.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Computational Physics U24568</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../03b/overview.html">
   Lecture 3b: Class Conundrums
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Introduction.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Initializing_a_class.html">
     Initializing a class
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Initializing_a_class_exercise.html">
     EXERCISE - Initializing a class
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Optional_arguments.html">
     Optional arguments
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Class_defining_practice.html">
     EXERCISES - Practicing defining classes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Attributes_and_inheritance.html">
     Class attributes and inheritence
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Attributes_and_inheritance_exercise.html">
     EXERCISE: Class attributes and inheritence
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Recap.html">
     Recap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Summary_exercises.html">
     SUMMARY EXERCISES
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/Acknowledgements.html">
     Acknowledgements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03b/CompPhys_Lect03b_2020_2021_ClassConundrums.html">
     Everything in one Notebook - Class Conundrums
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04a/overview.html">
   Lecture 4a: Advanced Techniques
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Introduction.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/List_comprehensions_overview.html">
     List comprehensions - Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/List_comprehensions_exercises1.html">
     List comprehensions - Exercises 1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/List_comprehensions_conditionals.html">
     List Comprehensions - Including conditionals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/List_comprehensions_exercises2.html">
     List Comprehensions - Exercises 2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Set_dictionary_comprehensions.html">
     Set and Dictionary Comprehensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Generators_overview.html">
     Generators - Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Generators_exercises1.html">
     Generators - Exercises 1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Generators_more_detail.html">
     Generators - A bit more complexity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Generators_exercises2.html">
     Generators - Exercises 2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Recursion_overview.html">
     Recursion - Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Recursion_exercises.html">
     Recursion - Exercises
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Lambda_overview.html">
     Function as a value and the lambda operator - Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Lambda_exercises.html">
     Function as a value and the lambda operator - Exercise
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/Summary_exercises.html">
     Summary Exercises
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04a/CompPhys_Lect04a_2022-23_AdvancedTechniques.html">
     Everything in one notebook - Advanced Techniques
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../08a/overview.html">
   Lecture 8a: Signal processing 1, Discrete Fourier Transforms
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_overview.html">
     Discrete Fourier Transforms - What is a Fourier transform?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_coding_help.html">
     Discrete Fourier Transforms - What we need to remember for coding
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_Coding_Easy.html">
     Coding up a Fourier transform - EASY(IER) VERSION
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_coding_hard.html">
     Coding up a Fourier transform - HARD VERSION
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_more_exercises.html">
     Discrete Fourier Transforms - Further Exercises
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/DFT_summary.html">
     Discrete Fourier Transforms - SUMMARY
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/Aliasing_introduction.html">
     Aliasing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/Aliasing_exercises.html">
     Aliasing exercises
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/Aliasing_summary.html">
     Aliasing Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08a/CompPhys_Lect08a_DataProcessing1_FourierTransforms.html">
     Data processing and manipulation techniques
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="overview.html">
   Lecture 9b: Code Optimization in Python (I)
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="introduction.html">
     Techniques to profile and optimise python code - I
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="installing_profilers.html">
     Importing necessary backends
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="optimization_example.html">
     A long(ish) example showing how to optimize a numerical integration code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="optimization_exercises.html">
     Some code optimization exercises - Removing for loops!
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="square_digits_opt.html">
     Interactive example of non numpy-able code optimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="using_the_right_tool.html">
     Identifying common elements in two large lists
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="sort_function.html">
     Writing a function to sort an array
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="example_sort_functions.html">
     Some sort methods to compare against
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="acknowledgements.html">
     Acknowledgements
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Techniques to profile and optimise python code
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/icg-gravwaves/U24568_Computational_Physics/master?urlpath=lab/tree/09b/CompPhys_Lect09b_2022_2023_OptimisingCode.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/icg-gravwaves/U24568_Computational_Physics/blob/master/09b/CompPhys_Lect09b_2022_2023_OptimisingCode.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/icg-gravwaves/U24568_Computational_Physics"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/icg-gravwaves/U24568_Computational_Physics/issues/new?title=Issue%20on%20page%20%2F09b/CompPhys_Lect09b_2022_2023_OptimisingCode.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/09b/CompPhys_Lect09b_2022_2023_OptimisingCode.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#before-we-start">
   Before we start
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#an-example">
   An example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#starting-to-understand-the-code">
   Starting to understand the code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-code">
   Profiling code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-these-tools-and-information-to-speed-things-up">
   Using these tools and information to speed things up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-1">
   Exercise 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-2-square-digits-again">
   Exercise 2 - Square digits (again)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2-summary">
     Exercise 2 - Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-3-identifying-common-elements-in-two-large-lists">
   Exercise 3 - Identifying common elements in two large lists
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-4-sorting-an-array">
   Exercise 4 - Sorting an array
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Techniques to profile and optimise python code</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#before-we-start">
   Before we start
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#an-example">
   An example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#starting-to-understand-the-code">
   Starting to understand the code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-code">
   Profiling code
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-these-tools-and-information-to-speed-things-up">
   Using these tools and information to speed things up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-1">
   Exercise 1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-2-square-digits-again">
   Exercise 2 - Square digits (again)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2-summary">
     Exercise 2 - Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-3-identifying-common-elements-in-two-large-lists">
   Exercise 3 - Identifying common elements in two large lists
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercise-4-sorting-an-array">
   Exercise 4 - Sorting an array
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="techniques-to-profile-and-optimise-python-code">
<h1>Techniques to profile and optimise python code<a class="headerlink" href="#techniques-to-profile-and-optimise-python-code" title="Permalink to this headline">#</a></h1>
<p>A common complaint about python is that “it’s not as fast as C/C++/fortran/…”. For example this recent article from Simon Portegies Zwart (<a class="reference external" href="https://arxiv.org/pdf/2009.11295.pdf">https://arxiv.org/pdf/2009.11295.pdf</a>) claims that one should not use python because it is inefficient, and therefore more environmentally harmful.</p>
<p>However, this statement was demonstrated to be untrue by Pierre Augier (see links from <a class="reference external" href="https://physicsworld.com/a/the-huge-carbon-footprint-of-large-scale-computing/">https://physicsworld.com/a/the-huge-carbon-footprint-of-large-scale-computing/</a>). Augier argues that while python will be slower than other languages if one does not consider optimization (often not needed if you just want to test something, or do something quickly), for large-scale simulations it can be made to be faster than the implementations of Portegies Zwart’s code in C/C++/fortran (<a class="reference external" href="https://github.com/paugier/nbabel">https://github.com/paugier/nbabel</a>).</p>
<p>So how do we do this? It is normally possible to write python code that is just as fast as code written in a “fast” (compiled) language such as C. After all, python is written in C and contains a wealth of libraries, such as numpy, that actually use compiled C (and even fortran) code in some of the most time-sensitive places.</p>
<p>I think its more accurate to say that its easier to write “slow” code in python, because it’s often hard to see why some things are slow. To write code that <em>is</em> as fast as C does require a bit of understanding on how C actually works, but in most cases you can write code that is more than fast enough using the techniques shown here. In this lecture we will try to</p>
<ul class="simple">
<li><p>Highlight some of the places where python code is often slow and demonstrate ways to speed it up</p></li>
<li><p>Demonstrate tools to “profile” python code, specifically to identify the functions, and lines, where the code is slowest</p></li>
</ul>
<p>As a supplement to this, there are occasionally cases where python doesn’t cut it in terms of speed. With the availability of numpy, <em>such cases are rare</em>. In such instances you can turn to “Cython” which is basically a hybrid of python and C/C++. We will cover Cython at the end of this course. Note that large parts of scipy are actually written in Cython, and while it is still nowhere near as well used as Python itself, it is increasing in popularity.</p>
<section id="before-we-start">
<h2>Before we start<a class="headerlink" href="#before-we-start" title="Permalink to this headline">#</a></h2>
<p>Before we start we will need to use a couple of utilities to demonstrate some of the profiling techniques. The cell below demonstrates how to do this in sciserver or Google Colab. <strong>If using Sciserver (or Google colab) just run the cell below</strong>.</p>
<p><strong>If not using sciserver or colab</strong>: This might not be the right way to install these utilities. If you are using Anaconda (or Minconda or any other conda installed python) you will probably want to use the <code class="docutils literal notranslate"><span class="pre">conda</span></code> command shown below and commented out <em>instead</em>. This is normally run in a terminal window. I can try to help you install these on your own machine, but I do not know your particular setup, and do not use Windows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="o">!{</span>sys.executable<span class="o">}</span> -m pip install line_profiler
<span class="o">!{</span>sys.executable<span class="o">}</span> -m pip install memory_profiler

<span class="c1"># conda install line_profiler</span>
<span class="c1"># conda install memory_profiler</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: line_profiler in /opt/homebrew/Caskroom/miniconda/base/envs/pycbc_test/lib/python3.9/site-packages (4.0.3)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: memory_profiler in /opt/homebrew/Caskroom/miniconda/base/envs/pycbc_test/lib/python3.9/site-packages (0.61.0)
Requirement already satisfied: psutil in /opt/homebrew/Caskroom/miniconda/base/envs/pycbc_test/lib/python3.9/site-packages (from memory_profiler) (5.9.4)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the stuff we imported above</span>
<span class="o">%</span><span class="k">load_ext</span> line_profiler
<span class="o">%</span><span class="k">load_ext</span> memory_profiler
</pre></div>
</div>
</div>
</div>
</section>
<section id="an-example">
<h2>An example<a class="headerlink" href="#an-example" title="Permalink to this headline">#</a></h2>
<p>Here’s an example code which integrates</p>
<p><span class="math notranslate nohighlight">\(cos(x) \times \frac{1}{x} \)</span></p>
<p>from <span class="math notranslate nohighlight">\(x = 1\)</span> to <span class="math notranslate nohighlight">\(x=1000\)</span>.</p>
<p>We will do this by using the simple rectangular method for numerically integrating. <a class="reference external" href="https://en.wikipedia.org/wiki/Riemann_sum">https://en.wikipedia.org/wiki/Riemann_sum</a> …. I know you all know the theory behind this, and how to code up such an example, as I taught it to you all in MATLAB last year!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE: We write this as a set of functions. Functions are better to isolate different parts of</span>
<span class="c1">#       the code and to be able to check each component individually. Using a class and class methods</span>
<span class="c1">#       to do this is also fine, and we mix both here to show this ... Might not be the most aesthetic</span>
<span class="c1">#       way of doing this, though! However, this does serve as a reminder: Don&#39;t write long blocks of code</span>
<span class="c1">#       split up into functions!</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">compute_cosx</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes cos(t) for all values in tseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cosx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
        <span class="n">cosx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tseries</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cosx</span>

<span class="k">def</span> <span class="nf">compute_invx</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes 1/x for all values in tseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
        <span class="n">invx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">tseries</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">invx</span>

<span class="k">def</span> <span class="nf">compute_seriesproduct</span><span class="p">(</span><span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiplies each element in series1 with the corresponding element in series2.</span>
<span class="sd">    This returns an array of the multiplied elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure the two arrays are the same length</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series1</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">series2</span><span class="p">))</span>
    <span class="n">seriessum</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series1</span><span class="p">)):</span>
        <span class="n">seriessum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">series1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">series2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">seriessum</span>

<span class="k">def</span> <span class="nf">compute_seriessum</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the sum of all values in series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sumvals</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)):</span>
        <span class="n">sumvals</span> <span class="o">=</span> <span class="n">sumvals</span> <span class="o">+</span> <span class="n">series</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sumvals</span>


<span class="k">class</span> <span class="nc">Integrator</span><span class="p">():</span>  
    <span class="k">def</span> <span class="nf">generate_integral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integral function goes here</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cosx</span> <span class="o">=</span> <span class="n">compute_cosx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tseries</span><span class="p">)</span>
        <span class="n">invx</span> <span class="o">=</span> <span class="n">compute_invx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tseries</span><span class="p">)</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">compute_seriesproduct</span><span class="p">(</span><span class="n">cosx</span><span class="p">,</span> <span class="n">invx</span><span class="p">)</span>
        <span class="n">summed_prod</span> <span class="o">=</span> <span class="n">compute_seriessum</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summed_prod</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the class and timeseries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">tmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">tmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">delta_t</span>
        <span class="n">tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
        <span class="c1"># We shift tseries by delta_t / 2 to ensure that we are using the midpoint rule (see wikipedia page)</span>
        <span class="n">tseries</span> <span class="o">=</span> <span class="n">tseries</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tseries</span> <span class="o">=</span> <span class="n">tseries</span>


<span class="k">def</span> <span class="nf">main_function</span><span class="p">():</span>
    <span class="n">intgr</span> <span class="o">=</span> <span class="n">Integrator</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">300.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intgr</span><span class="o">.</span><span class="n">generate_integral</span><span class="p">()</span>

<span class="nb">print</span> <span class="p">(</span><span class="n">main_function</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.33743511454087033
</pre></div>
</div>
</div>
</div>
</section>
<section id="starting-to-understand-the-code">
<h2>Starting to understand the code<a class="headerlink" href="#starting-to-understand-the-code" title="Permalink to this headline">#</a></h2>
<p>Our first step in understanding the code is to time it. This can be done in the following way:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> main_function()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.84 s ± 54.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Timeit will run the code a number of times and take an average. How many times it runs the code depends on how long the code takes (though you can override these values). Here we can see that our code took approximately a second to run. If running this only once then this is of course trivial.</p>
<p><strong>Important rule of optimising: Don’t waste time optimising a block of code, unless it is slowing down your work … If others are using your code, you must think about how they might use your code though, might it be a problem in the future? There are certainly some things in the code above that are unnecessarily slow, which can be made faster just by writing the code better in the first place</strong></p>
<p>Let’s assume though that we might need to run this code thousands of times (or hundreds of thousands of times). In that case let’s see what we can do to make it faster.</p>
</section>
<section id="profiling-code">
<h2>Profiling code<a class="headerlink" href="#profiling-code" title="Permalink to this headline">#</a></h2>
<p>Python and Jupyter notebooks have some neat tools for profiling code. Profiling means measuring how long the code takes to run individual blocks of code. Most profilers measure the fraction of time spent inside each individual <em>function</em>. Therefore splitting your code up into a number of different functions can help both in terms of making it easier to read and understand the code, but also in terms of understanding any bottlenecks.</p>
<p>Below we run a built-in profiler on our code above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">prun</span> -l 10 -q -T prun0 main_function()

<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prun0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
*** Profile printout saved to text file &#39;prun0&#39;.
         2999721 function calls in 1.960 seconds

   Ordered by: internal time
   List reduced from 14 to 10 due to restriction &lt;10&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.600    0.600    0.602    0.602 3642284310.py:18(compute_invx)
        1    0.484    0.484    0.633    0.633 3642284310.py:9(compute_cosx)
        1    0.478    0.478    0.481    0.481 3642284310.py:27(compute_seriesproduct)
        1    0.237    0.237    0.237    0.237 3642284310.py:39(compute_seriessum)
  2999700    0.148    0.000    0.148    0.000 {built-in method math.cos}
        3    0.006    0.002    0.006    0.002 {built-in method numpy.zeros}
        1    0.003    0.003    0.005    0.005 3642284310.py:61(__init__)
        1    0.002    0.002    0.002    0.002 {built-in method numpy.arange}
        1    0.001    0.001    1.959    1.959 3642284310.py:74(main_function)
        1    0.000    0.000    1.960    1.960 &lt;string&gt;:1(&lt;module&gt;)
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tottime</span></code> entry is the amount of time spent within each function. We can see that the majority of time is spent computing <code class="docutils literal notranslate"><span class="pre">cos(x)</span></code>, <code class="docutils literal notranslate"><span class="pre">inv(x)</span></code> and doing the series product and sum.</p>
<p>To introduce all of our profiling tools in one place, let’s also look at line-by-line and memory profiling. We can use the following to run the code to produce line-by-line profiling information</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1000.</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
<span class="c1">#compute_cosx(timeseries)</span>

<span class="o">%</span><span class="k">lprun</span> -T lprof0 -f main_function main_function()

<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lprof0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="c1"># And we can also profile the sub-functions, such as compute_cosx</span>

<span class="o">%</span><span class="k">lprun</span> -T lprof0 -f compute_cosx compute_cosx(timeseries)

<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;lprof0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>*** Profile printout saved to text file &#39;lprof0&#39;. 
Timer unit: 1e-09 s

Total time: 2.59384 s
File: /var/folders/67/1t4_rwdj441c8g3j147_fwrh0000gs/T/ipykernel_2518/3642284310.py
Function: main_function at line 74

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
    74                                           def main_function():
    75         1    5443000.0 5443000.0      0.2      intgr = Integrator(1, 10000, 1./300.)
    76         1 2588395000.0 2588395000.0     99.8      return intgr.generate_integral()

*** Profile printout saved to text file &#39;lprof0&#39;. 
Timer unit: 1e-09 s

Total time: 0.034721 s
File: /var/folders/67/1t4_rwdj441c8g3j147_fwrh0000gs/T/ipykernel_2518/3642284310.py
Function: compute_cosx at line 9

Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     9                                           def compute_cosx(tseries):
    10                                               &quot;&quot;&quot;
    11                                               Computes cos(t) for all values in tseries
    12                                               &quot;&quot;&quot;
    13         1      91000.0  91000.0      0.3      cosx = numpy.zeros(len(tseries))
    14     99900   12547000.0    125.6     36.1      for idx, tval in enumerate(tseries):
    15     99900   22083000.0    221.1     63.6          cosx[idx] = math.cos(tseries[idx])
    16         1          0.0      0.0      0.0      return cosx
</pre></div>
</div>
</div>
</div>
<p>Finally, although we will not use it in this class, we can also profile the <em>memory usage</em> of a function in the same way. Unfortunately this only works for functions written in an external file, so we need to dump our code to a file and then run it from the file. Here’s an example of that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%file</span> mprun_demo.py
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="k">def</span> <span class="nf">invx_demo</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes 1/x for all values in tseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">invx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">tseries</span>
    <span class="k">return</span> <span class="n">invx</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Overwriting mprun_demo.py
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mprun_demo</span> <span class="kn">import</span> <span class="n">invx_demo</span>
<span class="n">timeseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">10000.</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>

<span class="o">%</span><span class="k">mprun</span> -f invx_demo invx_demo(timeseries)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-these-tools-and-information-to-speed-things-up">
<h2>Using these tools and information to speed things up<a class="headerlink" href="#using-these-tools-and-information-to-speed-things-up" title="Permalink to this headline">#</a></h2>
<p>Okay, now that we’ve understood the tools available to us. Let’s try to see if we can’t improve things. The first place where the code is slow is in the <code class="docutils literal notranslate"><span class="pre">compute_cosx</span></code> function. Here’s a major rule in python optimization:</p>
<ul class="simple">
<li><p>Avoid for loops wherever possible</p></li>
</ul>
<p>In this case rather than using a python for loop to compute <code class="docutils literal notranslate"><span class="pre">cos(x)</span></code> at every index, let’s use numpy to compute it at all indexes in one call. Yes, internally it will still need to loop over all values of <code class="docutils literal notranslate"><span class="pre">x</span></code> at some point and compute <code class="docutils literal notranslate"><span class="pre">cos(x)</span></code> for each point, but this will happen deep in some compiled numpy routine. In short</p>
<ul class="simple">
<li><p>Use numpy routines on vectors to avoid for loops where possible.</p></li>
</ul>
<p>So we can replace our <code class="docutils literal notranslate"><span class="pre">compute_cosx</span></code> function with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_cosx</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes cos(t) for all values in tseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tseries</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that running this <em>after</em> the block above just replaces this function, so we can just run our profiler again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">prun</span> -l 10 -q -T prun0 main_function()

<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prun0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
*** Profile printout saved to text file &#39;prun0&#39;.
         19 function calls in 1.374 seconds

   Ordered by: internal time
   List reduced from 13 to 10 due to restriction &lt;10&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.605    0.605    0.607    0.607 3642284310.py:18(compute_invx)
        1    0.474    0.474    0.476    0.476 3642284310.py:27(compute_seriesproduct)
        1    0.238    0.238    0.238    0.238 3642284310.py:39(compute_seriessum)
        1    0.047    0.047    0.047    0.047 1481541755.py:1(compute_cosx)
        2    0.004    0.002    0.004    0.002 {built-in method numpy.zeros}
        1    0.003    0.003    0.005    0.005 3642284310.py:61(__init__)
        1    0.002    0.002    0.002    0.002 {built-in method numpy.arange}
        1    0.002    0.002    1.374    1.374 3642284310.py:74(main_function)
        1    0.000    0.000    1.374    1.374 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    1.367    1.367 3642284310.py:50(generate_integral)
</pre></div>
</div>
</div>
</div>
<p>Now we can see that quite a bit of time is being spent in the remaining 3 <code class="docutils literal notranslate"><span class="pre">compute_x</span></code> functions. Let’s try optimizing these as well by replacing the for loops with numpy vectorized calls</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_invx</span><span class="p">(</span><span class="n">tseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes 1/x for all values in tseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">tseries</span>

<span class="k">def</span> <span class="nf">compute_seriesproduct</span><span class="p">(</span><span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiplies each element in series1 with the corresponding element in series2.</span>
<span class="sd">    This returns an array of the multiplied elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure the two arrays are the same length</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series1</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">series2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">series1</span> <span class="o">*</span> <span class="n">series2</span>

<span class="k">def</span> <span class="nf">compute_seriessum</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the sum of all values in series</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="o">%</span><span class="k">prun</span> -l 10 -q -T prun0 main_function()

<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;prun0&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
*** Profile printout saved to text file &#39;prun0&#39;.
         16 function calls in 0.060 seconds

   Ordered by: internal time
   List reduced from 15 to 10 due to restriction &lt;10&gt;

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1    0.048    0.048    0.048    0.048 1481541755.py:1(compute_cosx)
        1    0.003    0.003    0.005    0.005 3642284310.py:61(__init__)
        1    0.003    0.003    0.003    0.003 {built-in method numpy.arange}
        1    0.002    0.002    0.002    0.002 1855454630.py:7(compute_seriesproduct)
        1    0.002    0.002    0.002    0.002 1855454630.py:1(compute_invx)
        1    0.001    0.001    0.060    0.060 3642284310.py:74(main_function)
        1    0.001    0.001    0.001    0.001 {method &#39;reduce&#39; of &#39;numpy.ufunc&#39; objects}
        1    0.000    0.000    0.060    0.060 &lt;string&gt;:1(&lt;module&gt;)
        1    0.000    0.000    0.060    0.060 {built-in method builtins.exec}
        1    0.000    0.000    0.053    0.053 3642284310.py:50(generate_integral)
</pre></div>
</div>
</div>
</div>
<p>The code is now limited be a vectorized computation of cos(x). Not easy to make that much faster! Now with these optimizations let’s see how fast our code runs</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> main_function()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>57.6 ms ± 380 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<p>The code now runs <em>2 orders of magnitude</em> quicker. For loops over a large number of values can be very inefficient!</p>
</section>
<section id="exercise-1">
<h2>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">#</a></h2>
<p>The following cells contain examples of python code that are written using explicit for loops. Time these functions (using <code class="docutils literal notranslate"><span class="pre">timeit</span></code>) and rewrite the for loop using numpy calls. After rewriting, time the functions again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXERCISE 1.1 - Here also investigate the time taken to compute these two functions. Which is faster?</span>
<span class="c1"># Why do you think this is?</span>
<span class="c1"># Numpy is really inefficient when running on scalar values.</span>
<span class="kn">import</span> <span class="nn">numpy</span><span class="o">,</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">compute_sin_tseries</span><span class="p">():</span>
    <span class="n">tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
    <span class="n">sin_tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)):</span>
        <span class="n">sin_tseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sin_tseries</span>

<span class="k">def</span> <span class="nf">compute_sin_tseries2</span><span class="p">():</span>
    <span class="n">tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
    <span class="n">sin_tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)):</span>
        <span class="n">sin_tseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sin_tseries</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution to exercise 1.1 goes in here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXERCISE 1.2</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">numpy</span>

<span class="k">def</span> <span class="nf">compute_exp_tseries</span><span class="p">():</span>
    <span class="n">tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
    <span class="n">exp_tseries</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tseries</span><span class="p">)):</span>
        <span class="n">exp_tseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span> <span class="o">**</span> <span class="n">tseries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">exp_tseries</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution to exercise 1.2 goes in here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXERCISE 1.3 - Note that there are two for loops here. It is possible to collapse into one</span>
<span class="c1"># single vectorized call, but simply removing one of the for loops will make the code both readable</span>
<span class="c1"># and reasonably optimized. Feel free to try this for yourself, but it is *not at all* trivial</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">sum_2d_array_to_1d</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes as input a 2-dimensional array, for example:</span>
<span class="sd">    [[0,1,2,3],</span>
<span class="sd">     [2,2,2,2],</span>
<span class="sd">     [1,1,1,1],</span>
<span class="sd">     [10,11,12,13]]</span>
<span class="sd">    </span>
<span class="sd">    It should sum over each of the *rows* in turn and return the sum of each as a new array</span>
<span class="sd">    </span>
<span class="sd">    [6, 8, 4, 46]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)):</span>
        <span class="c1"># Looping over each row</span>
        <span class="n">current_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="c1"># Looping over each element in each row, e.g. 10-&gt;11-&gt;12-&gt;13 if the bottom row</span>
            <span class="n">current_sum</span> <span class="o">+=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_sum</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="c1"># Short example to test that it works</span>
<span class="n">input_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">]])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sum_2d_array_to_1d</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>

<span class="c1"># *This* is the large example to use timeit on and to make fast to run</span>
<span class="n">input_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2000</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sum_2d_array_to_1d</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ 6.  8.  4. 46.]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1015.91910122 1015.26621297 1014.87415966 ...  986.9555384  1012.2705617
  991.45864318]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution to exercise 1.3 goes in here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EXERCISE 1.4</span>

<span class="c1"># This example performs a cross-correlation (hmm, now where have we seen that before? Does this feel</span>
<span class="c1"># like something that would be **very, very important** for the coursework??. Of course the unoptimized</span>
<span class="c1"># code below would work .... I just think it would take about 2 hours *per run* on the coursework data.</span>


<span class="k">def</span> <span class="nf">compute_cross_correlation</span><span class="p">():</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">cross_correlation</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)):</span>
        <span class="n">curr_cross_corr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)):</span>
            <span class="n">curr_cross_corr</span> <span class="o">+=</span> <span class="n">signal</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
        <span class="n">cross_correlation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_cross_corr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution to exercise 1.4 goes in here</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-2-square-digits-again">
<h2>Exercise 2 - Square digits (again)<a class="headerlink" href="#exercise-2-square-digits-again" title="Permalink to this headline">#</a></h2>
<p>In the debugging lecture last year we showed an example of a [not working] code to do the following:</p>
<ul class="simple">
<li><p>Consider a sequence of numbers a0, a1, …, an, in which an element is equal to the sum of squared digits of the previous element. The sequence ends once an element that has already been in the sequence appears again. So that an = a0. Given the first element a0, find the length of the sequence.</p></li>
</ul>
<p>So for example if a0 = 16. <code class="docutils literal notranslate"><span class="pre">1**2</span> <span class="pre">+</span> <span class="pre">6**2</span> <span class="pre">=</span> <span class="pre">37</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">3**2</span> <span class="pre">+</span> <span class="pre">7**2</span> <span class="pre">=</span> <span class="pre">58</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">5**2</span> <span class="pre">+</span> <span class="pre">8**2</span> <span class="pre">=</span> <span class="pre">89</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">8**2</span> <span class="pre">+</span> <span class="pre">9**2</span> <span class="pre">=</span> <span class="pre">145</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">1**2</span> <span class="pre">+</span> <span class="pre">4**2</span> <span class="pre">+</span> <span class="pre">5**2</span> <span class="pre">=</span> <span class="pre">42</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">4**2</span> <span class="pre">+</span> <span class="pre">2**2</span> <span class="pre">=</span> <span class="pre">20</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">2**2</span> <span class="pre">+</span> <span class="pre">0**2</span> <span class="pre">=</span> <span class="pre">4</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">4**2</span> <span class="pre">=</span> <span class="pre">16</span></code> We’ve already seen 16 so we stop here. The sequence is <code class="docutils literal notranslate"><span class="pre">[16,37,58,89,145,42,20,4,16]</span></code> which has a length of 9, return 9.</p>
<p>The code that we used had some optimisations, but was not particularly clear. To try to understand it better let’s write this out in a code that approaches the problem in a different way, with comments etc. to try to make it clearer what is going on</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">square_digits</span><span class="p">(</span><span class="n">input_number</span><span class="p">):</span>

    <span class="c1"># Initialize by setting the list of outputs equal to the input</span>
    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_number</span><span class="p">]</span>
    <span class="c1"># And setting the last_number variable to the input</span>
    <span class="n">last_number</span> <span class="o">=</span> <span class="n">input_number</span>

    <span class="c1"># This is basically a for-loop that will only exit when we explicitly say &quot;exit&quot;</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Step one: We must identify the digits of last_number</span>
        <span class="c1"># Cast to a string</span>
        <span class="n">last_number</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_number</span><span class="p">)</span>
        <span class="c1"># And then convert to a list of integers. We do this using a list comprehension, which is powerful, but not fast</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">last_number</span><span class="p">]</span>
        <span class="c1"># So if last_number is 49120 then digits = [4,9,1,2,0]</span>
        
        <span class="c1"># We can then sum the digits squared using another list comprehension</span>
        <span class="c1"># digits = [4,9,1,2,0] -&gt; 16 + 81 + 1 + 4 = 102</span>
        <span class="n">digit_squared_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">digit</span><span class="o">*</span><span class="n">digit</span> <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">digits</span><span class="p">])</span>
        
        <span class="c1"># Is this value already in the list?</span>
        <span class="k">if</span> <span class="n">digit_squared_sum</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
            <span class="c1"># Add this value and then exist</span>
            <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digit_squared_sum</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Else add the value and then continue</span>
            <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digit_squared_sum</span><span class="p">)</span>
            <span class="n">last_number</span> <span class="o">=</span> <span class="n">digit_squared_sum</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square_digits(103) gives:&quot;</span><span class="p">,</span><span class="n">square_digits</span><span class="p">(</span><span class="mi">103</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Should be 4&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;square_digits(612) gives:&quot;</span><span class="p">,</span><span class="n">square_digits</span><span class="p">(</span><span class="mi">612</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Should be 16&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>square_digits(103) gives: 4 
 Should be 4

square_digits(612) gives: 16 
 Should be 16
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s try it with the following</span>
<span class="n">very_long_integer</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">100</span>
<span class="n">square_digits</span><span class="p">(</span><span class="n">very_long_integer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13
</pre></div>
</div>
</div>
</div>
<p>Using the profiling tools demonstrated above:</p>
<ul class="simple">
<li><p>Use timeit to calculate how long the function takes to run with the <code class="docutils literal notranslate"><span class="pre">very_long_integer</span></code></p></li>
<li><p>Use lprun to determine how long the code spends at each line</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>Here is the optimized code that we used last year (with the bug fixed). As before run timeit and lprof on this code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">square_digits_withoutstr</span><span class="p">(</span><span class="n">input_number</span><span class="p">):</span>

    <span class="n">cur</span> <span class="o">=</span> <span class="n">input_number</span>
    <span class="n">was</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cur</span> <span class="ow">in</span> <span class="n">was</span><span class="p">):</span>
        <span class="n">was</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
        <span class="n">nxt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">cur</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nxt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cur</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cur</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">//=</span> <span class="mi">10</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">nxt</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">was</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>Now repeat the process using:
<code class="docutils literal notranslate"><span class="pre">very_long_integer=2**100000</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>

<span class="n">very_long_integer</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">100000</span>
</pre></div>
</div>
</div>
</div>
<section id="exercise-2-summary">
<h3>Exercise 2 - Summary<a class="headerlink" href="#exercise-2-summary" title="Permalink to this headline">#</a></h3>
<p>Think about what these results are telling you. Some things to highlight:</p>
<ul class="simple">
<li><p>You are learning how to identify which parts of a function you need to think about when optimising. Never bother optimising any part of your code that is not taking a significant fraction of the total time.</p></li>
<li><p>The optimal solution to a problem can depend on the input. For shorter inputs, converting an integer to a string and then back to a list of integers adds an overhead that is the dominant computational cost. However, as the input integers become very large, operations like dividing by 10 (which for a computer is not as trivial as it seems, because computers think in binary numbers, not base-10 numbers) become expensive (look up how python handles big integers if you want to understand this better). In this case the overhead of converting to a string is faster.</p></li>
<li><p>Although the second case was faster for normal-sized integers, it doesn’t seem that using it would really be a good decision if the code is more difficult to parse.</p></li>
</ul>
</section>
</section>
<section id="exercise-3-identifying-common-elements-in-two-large-lists">
<h2>Exercise 3 - Identifying common elements in two large lists<a class="headerlink" href="#exercise-3-identifying-common-elements-in-two-large-lists" title="Permalink to this headline">#</a></h2>
<p>This interactive example demonstrates that is often important to use the right tool, or computational method, for the task at hand.</p>
<p>An example of this is the problem I set the first years earlier this year:</p>
<p>Write a function numpy_nested_sum, which takes as input two 1D numpy arrays (x and y) with lengths N and M respectively and computes the following sum:</p>
<p><span class="math notranslate nohighlight">\(\sum_{i=0}^{N-1} \sum_{j=0}^{M-1} \left(x[i]^2 + y[j]^2 \right)\)</span></p>
<p>Many of the students tried something like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_sum</span><span class="p">(</span><span class="n">arrx</span><span class="p">,</span> <span class="n">arry</span><span class="p">):</span>
    <span class="n">summ</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrx</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arry</span><span class="p">)):</span>
            <span class="n">summ</span> <span class="o">+=</span> <span class="n">arrx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">arry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">summ</span>
</pre></div>
</div>
</div>
</div>
<p>This directly implements the question as written, but didn’t pass the longest test case (due to timeout). Those students that remembered that they were also highly trained mathemeticians did some algebraic reordering and realised that this was equal to:</p>
<p><span class="math notranslate nohighlight">\(\sum_{i=0}^{N-1} (M * x[i]^2) +  \sum_{j=0}^{M-1} ( N * y[j]^2)\)</span></p>
<p>This is then coded as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_sum</span><span class="p">(</span><span class="n">arrx</span><span class="p">,</span> <span class="n">arry</span><span class="p">):</span>
    <span class="n">summ</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrx</span><span class="p">)):</span>
        <span class="n">summ</span> <span class="o">+=</span> <span class="n">M</span> <span class="o">*</span> <span class="n">arrx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arry</span><span class="p">)):</span>
        <span class="n">summ</span> <span class="o">+=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">arry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">summ</span>
</pre></div>
</div>
</div>
</div>
<p>and the students got full marks. The hint in the function name (to call this <em>nested</em> sum), was a bit unfair of course. However, the principal here is the important one: How many operations do you actually need to do to get the necessary output? This is called “complexity analysis” in computing, this article has a lot more details on this:</p>
<p><a class="reference external" href="https://www.freecodecamp.org/news/big-o-notation-why-it-matters-and-why-it-doesnt-1674cfa8a23c/">https://www.freecodecamp.org/news/big-o-notation-why-it-matters-and-why-it-doesnt-1674cfa8a23c/</a></p>
<p>Let’s consider a different problem:</p>
<ul class="simple">
<li><p>Consider two large lists of integers. Identify integers which are in <em>both</em> lists</p></li>
</ul>
<p>First let’s create the lists and then let’s take a first stab at this</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s create our lists first - DO NOT change this code</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">list_a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000000</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">100000</span><span class="p">])</span>
<span class="n">list_b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10000000</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">100000</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Then let&#39;s write our first solution</span>
<span class="k">def</span> <span class="nf">identify_common_elements</span><span class="p">(</span><span class="n">list_1</span><span class="p">,</span> <span class="n">list_2</span><span class="p">):</span>
    <span class="n">common_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Let&#39;s just write a for loop, and for every element check if it&#39;s in list_2</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list_1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>
            <span class="n">common_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">common_elements</span>

<span class="c1"># This seems like it should be fast, right??</span>
</pre></div>
</div>
</div>
</div>
<p>As before, run timeit and lprof on this code to determine run-time and the slowest line. <em>Before</em> running lprof identify where you think the most time will be taken, in which line of the code. Were you right?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>Most of the time is spent determining if elem is in list 2, for every element. There are in total <code class="docutils literal notranslate"><span class="pre">O(N**2)</span></code> operations in this operation, where N is the length of the array. Specifically for each of the <code class="docutils literal notranslate"><span class="pre">N</span></code> elements in list 1 we have to check if any of the <code class="docutils literal notranslate"><span class="pre">N</span></code> elements in list 2 are the same. (There would be some special cases here, for example if the lists have a length of 1000000, but contained only integers between 0 and 10).</p>
<p>Can we do better? How can we speed up the <code class="docutils literal notranslate"><span class="pre">elem</span> <span class="pre">in</span> <span class="pre">list_2</span></code> part of the code? How about this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s try that again</span>
<span class="k">def</span> <span class="nf">identify_common_elements_with_a_set</span><span class="p">(</span><span class="n">list_1</span><span class="p">,</span> <span class="n">list_2</span><span class="p">):</span>
    <span class="c1"># ALL I DO IS ADD THE FOLLOWING 1 LINE</span>
    <span class="n">list_2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_2</span><span class="p">)</span>
    <span class="n">common_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Let&#39;s just write a for loop, and for every element check if it&#39;s in list_2</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list_1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">list_2</span><span class="p">:</span>
            <span class="n">common_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">common_elements</span>

<span class="c1"># This seems like it wouldn&#39;t be any faster, right??</span>
</pre></div>
</div>
</div>
</div>
<p>Again use timeit and lprof to profile the code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>Think about why that happened?</p>
<p>Sometimes optimisations in python aren’t obvious, because a lot of the internal details can be hidden. A <code class="docutils literal notranslate"><span class="pre">set</span></code> and a <code class="docutils literal notranslate"><span class="pre">list</span></code> are similar but very different objects. On the face of it a <code class="docutils literal notranslate"><span class="pre">set</span></code> just contains a list of non-duplicated entries (So <code class="docutils literal notranslate"><span class="pre">set([1,1,2,3,4])</span></code> = <code class="docutils literal notranslate"><span class="pre">set([1,2,3,4])</span></code>). But because non-duplicate entries are not possible the set can check if an item is in the <code class="docutils literal notranslate"><span class="pre">set</span></code><em>much</em> more quickly than you can check if an item is in a list … Basically python implements a technique called a “hash table” <a class="reference external" href="https://en.wikipedia.org/wiki/Hash_table">https://en.wikipedia.org/wiki/Hash_table</a> to decide quickly if an object is already in the set. Dictionaries use the same technique with their keys. (Also look up binary search tables as another interesting technique for this kind of thing).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># One more try</span>
<span class="k">def</span> <span class="nf">identify_common_elements_with_two_sets</span><span class="p">(</span><span class="n">list_1</span><span class="p">,</span> <span class="n">list_2</span><span class="p">):</span>
    <span class="n">list_1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_1</span><span class="p">)</span>
    <span class="n">list_2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">list_1</span> <span class="o">&amp;</span> <span class="n">list_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Again profile this code, is it quicker than the previous version?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> operator to take the combination of the two lists. This results in a code with much fewer lines, but the overall cost is much the same. <em>Converting</em> a list to a set would be a non-negligible cost here, but if your input is already a set, and your output can be a set then this operation will be faster.:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_a</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_a</span><span class="p">)</span>
<span class="n">set_b</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">list_b</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> set_a &amp; set_b
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.75 ms ± 4.77 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
</pre></div>
</div>
</div>
</div>
<p>Can we do even better and record integers that occur multiple times in both lists? This algorithm sorts the input and then walks through the sorted arrays looking for duplicates. The sorting is a <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">log</span> <span class="pre">N</span></code> operation, and the walkthrough requires <code class="docutils literal notranslate"><span class="pre">O(N)</span></code> operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s try that again</span>
<span class="k">def</span> <span class="nf">identify_common_elements_with_a_walk</span><span class="p">(</span><span class="n">list_1</span><span class="p">,</span> <span class="n">list_2</span><span class="p">):</span>
    <span class="n">list_1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_1</span><span class="p">)</span>
    <span class="n">list_2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_2</span><span class="p">)</span>
    <span class="n">idx_1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx_2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_1</span><span class="p">)</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_2</span><span class="p">)</span>
    <span class="n">common_elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_1</span> <span class="o">=</span> <span class="n">list_1</span><span class="p">[</span><span class="n">idx_1</span><span class="p">]</span>
    <span class="n">curr_2</span> <span class="o">=</span> <span class="n">list_2</span><span class="p">[</span><span class="n">idx_2</span><span class="p">]</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">curr_1</span> <span class="o">==</span> <span class="n">curr_2</span><span class="p">:</span>
            <span class="n">common_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_1</span><span class="p">)</span>
            <span class="n">idx_1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx_1</span> <span class="o">==</span> <span class="n">l1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">curr_1</span> <span class="o">=</span> <span class="n">list_1</span><span class="p">[</span><span class="n">idx_1</span><span class="p">]</span>
            <span class="n">idx_2</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx_2</span> <span class="o">==</span> <span class="n">l2</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">curr_2</span> <span class="o">=</span> <span class="n">list_2</span><span class="p">[</span><span class="n">idx_2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">curr_1</span> <span class="o">&lt;</span> <span class="n">curr_2</span><span class="p">:</span>
            <span class="n">idx_1</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx_1</span> <span class="o">==</span> <span class="n">l1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">curr_1</span> <span class="o">=</span> <span class="n">list_1</span><span class="p">[</span><span class="n">idx_1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx_2</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx_2</span> <span class="o">==</span> <span class="n">l2</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">curr_2</span> <span class="o">=</span> <span class="n">list_2</span><span class="p">[</span><span class="n">idx_2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">common_elements</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run timeit and lprun here</span>
</pre></div>
</div>
</div>
</div>
<p>For the data arrays we are considering this is not faster, even if the arrays are sorted before sending to the function. That’s probably not surprising. The <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> method on the two sets would have implemented this if it were faster!</p>
</section>
<section id="exercise-4-sorting-an-array">
<h2>Exercise 4 - Sorting an array<a class="headerlink" href="#exercise-4-sorting-an-array" title="Permalink to this headline">#</a></h2>
<p>Sorting arrays is a common operation. Making a sorting algorithm that is <em>fast</em> is very important and there are many different approaches to the problem (python, for example uses “Timsort”):</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Sorting_algorithm">https://en.wikipedia.org/wiki/Sorting_algorithm</a></p>
<p>There is a rule though: If you have an array that contains random input, then you will require an average of <code class="docutils literal notranslate"><span class="pre">O(N</span> <span class="pre">log(N))</span></code> operations to sort the array. If the array is <em>not</em> random though, this can be shorter (e.g. if the array is already sorted, this can be done in <code class="docutils literal notranslate"><span class="pre">O(N)</span></code>, which is the cost required to identify that the array <em>is</em> sorted.</p>
<p>As this is the last exercise, let’s make this challenging:</p>
<ul class="simple">
<li><p>Write your own code that will take as input an array of numbers. Return a sorted <em>copy</em> of the array (the original array should be unchanged). Don’t worry too much about making the code fast until you have something that works. When you have something that works, see how you can use the tools presented above to make it as fast as possible.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="k">def</span> <span class="nf">sort_array</span><span class="p">(</span><span class="n">unsorted_array</span><span class="p">):</span>
    <span class="c1"># This line will copy the array so that the input will be preserved.</span>
    <span class="c1"># After this you can do what you want to unsorted_array</span>
    <span class="n">unsorted_array</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">unsorted_array</span><span class="p">)</span>
    
    <span class="c1"># FIXME: You need to fill this with code DO NOT use python&#39;s built-in sort/sorted routines (or any link to</span>
    <span class="c1"># that e.g. numpy.sorted). The problem is to think about how you would do this!</span>
    
    <span class="k">return</span> <span class="n">sorted_array</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use this cell to profile your code.</span>
</pre></div>
</div>
</div>
</div>
<p>How does your code compare with other code? Here’s three examples of pre-existing sorting algorithms. The first is python’s built-in <code class="docutils literal notranslate"><span class="pre">sort</span></code> routine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sorted_array</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unsorted_array</span><span class="p">)</span>
</pre></div>
</div>
<p>The next three functions are implications of</p>
<ul class="simple">
<li><p>The “quicksort” technique</p></li>
<li><p>The “mergsort” technique</p></li>
<li><p>The “bubblesort” technique</p></li>
</ul>
<p>See here for a description of each of these</p>
<p><a class="reference external" href="https://app.codesignal.com/interview-practice/topics/sorting/tutorial">https://app.codesignal.com/interview-practice/topics/sorting/tutorial</a></p>
<p>or here</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Sorting_algorithm">https://en.wikipedia.org/wiki/Sorting_algorithm</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="k">def</span> <span class="nf">quick_sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">copied</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">l</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">r</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
    
    <span class="c1"># This is an example of a recursive program. Where we call a function from within the *same* function with a</span>
    <span class="c1"># reduced scope. However, this will make profiling hard!</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">quick_sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">quick_sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">copied</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">merge_sort</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">left</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">middle</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">middle</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sequence</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">middle</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
            <span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">left</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">split</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">middle</span><span class="p">)</span>
        <span class="n">split</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">merge</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

    <span class="n">split</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">sequence</span>

<span class="k">def</span> <span class="nf">bubble_sort</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">firstIndex</span><span class="p">,</span> <span class="n">secondIndex</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">firstIndex</span><span class="p">]</span>
        <span class="n">items</span><span class="p">[</span><span class="n">firstIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">secondIndex</span><span class="p">]</span>
        <span class="n">items</span><span class="p">[</span><span class="n">secondIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="n">stop</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_swap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">items</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">swap</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">last_swap</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">last_swap</span>
    <span class="k">return</span> <span class="n">items</span>
</pre></div>
</div>
</div>
</div>
<p>For each of the arrays below, time how long it takes to sort the array with each of the methods above, including your own function and the built-in <code class="docutils literal notranslate"><span class="pre">sorted</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Array of random numbers</span>
<span class="n">array_a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1"># An already sorted array</span>
<span class="n">array_b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="c1"># An *inversely* sorted array</span>
<span class="n">array_c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># Two sorted arrays appended together</span>
<span class="n">array_d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>

<span class="c1"># Time the various sorting algorithms below</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">#</a></h2>
<p>With thanks to the following</p>
<ul class="simple">
<li><p><a class="reference external" href="https://ipython-books.github.io">https://ipython-books.github.io</a></p></li>
<li><p><a class="reference external" href="https://jakevdp.github.io/PythonDataScienceHandbook">https://jakevdp.github.io/PythonDataScienceHandbook</a></p></li>
<li><p><a class="reference external" href="https://app.codesignal.com">https://app.codesignal.com</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "icg-gravwaves/U24568_Computational_Physics",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./09b"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="acknowledgements.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Acknowledgements</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Becky Canning, Ian Harry and Andrew Lundgren<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>